---
title: "Match comparisons"
date: "July 18, 2016"
output:
  pdf_document
---

This document was produced using code in `match_analysis.Rmd`. (To make a `.md` version, run `knit("match_analysis.Rmd")` followed by `pandoc('match_analysis.md', format='markdown_github')`))

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Matching StreetEvents to CRSP

Our goal is to match StreetEvents conference calls to PERMNOs on CRSP.
StreetEvents conferences calls are identified (pretty much) by their `file_name` values.

We have an "automatic" match created by code in `crsp_link.sql` and stored in
the database table `streetevents.crsp_link`.
I put "automatic" in quotes because this code does leverage manual matches in a
[Google Sheets document](https://docs.google.com/spreadsheets/d/14F6zjJQZRsf5PonOfZ0GJrYubvx5e_eHMV_hCGe42Qg/).

We also have a table that represented our *prior* definitive mapping in `streetevents.company_link`.
But this table was out of date and we needed to update it.
Unfortunately, the process by which it was created was not well understood and not documented.

So the first order of business was to examine differences between
`streetevents.crsp_link` and `streetevents.company_link`:

- Are the matches in `streetevents.company_link` generally better?
- Are differences in PERMNO matches to unrelated firms? Or to the same firm (i.e., same `permco`) but different security (i.e., different `permno`).
    - If the latter, are we getting the "right" `permno` in general in  `streetevents.company_link`?
- Can we come up with a way of flagging cases that need correction?
    - Differences between  `streetevents.company_link` and `streetevents.crsp_link` will often represent bad matches in `streetevents.company_link` that we identified and corrected.
How can we identify these? One known issue is the tendency of ThomsonReuters (the provider of StreetEvents) to "backdate" ticker and company names for acquired companies. These can usually be identified by discrepancies between `co_name` and `call_desc`.

```{r load_packages, include=FALSE}
library(dplyr)
library(knitr)
```

```{r data_step, warning=FALSE, include=FALSE}
# Use Sys.setenv(PGUSER = "rudyardrichter", PGPASSWORD = "xxxxxx") if necessary.
pg <- src_postgres(host = "aaz.chicagobooth.edu", dbname = "postgres")

tbl_pg <- function(table) {
    tbl(pg, sql(paste0("SELECT * FROM ", table)))
}

# Run code in streetevents/crsp_link.sql to create
# streetevents.crsp_link
crsp_link <- tbl_pg("streetevents.crsp_link")
company_link <- tbl_pg("streetevents.company_link")
manual_permno_matches <- tbl_pg("streetevents.manual_permno_matches")
calls <- tbl_pg("streetevents.calls")
stocknames <- tbl_pg("crsp.stocknames")
```

# Comparing `streetevents.crsp_link` and `streetevents.company_link`

Let's join these two tables using `file_name` to see how often we get the same
`permno` in both tables.

```{r match_compare, echo=FALSE}
# How many firms have the same PERMCO as identified with
# the ticker match?
match_compare <-
    crsp_link %>%
    inner_join(company_link, by="file_name", suffix=c("_crsp", "_comp")) %>%
    
    inner_join(
        stocknames %>% 
            select(permno, permco) %>%
            distinct() %>% 
            rename(permno_comp=permno, permco_comp=permco), by="permno_comp") %>%
    inner_join(
        stocknames %>% 
            select(permno, permco) %>%
            distinct() %>% 
            rename(permno_crsp=permno, permco_crsp=permco), by="permno_crsp") %>%
    mutate(same_permno=permno_crsp==permno_comp,
           same_permco=permco_crsp==permco_comp) %>%
    compute()

```

```{r stat, include=FALSE}
same_stat <-
    match_compare %>%
    summarize(sum(as.integer(same_permco)*1)/count(same_permco)) %>%
    collect() %>%
    .[[1]]
```
It seems we get the same match in `r sprintf("%.0f%%", same_stat*100)` of cases.

Here are the raw numbers:
```{r compare, echo=FALSE}
    match_compare %>%
    group_by(same_permco) %>%
    summarize(count=n()) %>%
    kable()
```

I have checked the few remaining cases of disagreement and we currently have the right (manual) match.

```{r disagree_match_type, echo=FALSE}
    match_compare %>%
    filter(!same_permco) %>%
    count(match_type_desc) %>%
    kable()
```
